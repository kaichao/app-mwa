name: beam-make.test
label: 单元测试
cluster: dcu
parameters:
  initial_status: RUNNING

jobs:
  beam-make:
    base_image: ${MWA_VCSTOOLS}
    command: ${ROCM_COMMAND}
    arguments:
      slot_options: reserved_on_exit
      code_path: ${CODE_BASE}/beam-make/code
    parameters:
      key_group_regex: ^([0-9]+)$
      start_message:
    environments:
      - LOCAL_INPUT_ROOT=${LOCAL_INPUT_ROOT}
      - LOCAL_OUTPUT_ROOT=${LOCAL_OUTPUT_ROOT}
      - KEEP_TARGET_FILE=yes
    hosts:
      - n-02:${NUM_SLOTS}
    sink_jobs:
      - down-sample

  down-sample:
    base_image: ${DOWN_SAMPLE}
    arguments:
      # 20-min
      max_sleep_count: 200
      slot_options: reserved_on_exit
      code_path: ${CODE_BASE}/down-sample/code
    parameters:
      key_group_regex: ^(.+)$
    environments:
      - LOCAL_INPUT_ROOT=${LOCAL_SHM_ROOT}
      - LOCAL_OUTPUT_ROOT=${LOCAL_SHM_ROOT}
      - KEEP_SOURCE_FILE=no
      - ENABLE_LOCAL_COMPUTE=${ENABLE_LOCAL_COMPUTE}
    hosts:
      - n-02:1
    sink_jobs:
      - next

  next:
    base_image: hub.cstcloud.cn/scalebox/agent
