# beam-maker的性能测试实验

测试环境：
- 配置
  - CPU：单路32核Hygon C86 7185
  - 内存：128GB
  - SSD：240GB
  - 4路DCU
- 测试数据从本地SSD加载，中间数据、处理结果放在本地tmpfs（/dev/shm）中

## 一、240秒时长单DCU测试

| pointing | run-seconds | avg-seconds | DCU VRAM | idle interval | busy interval | busy power | CPU usage       |
|----------|-------------|-------------|----------|---------------|---------------|------------|-----------------|
| 1        | 58.59       | 58.59       | 48%      | 11            | 9             | 70~75      | 5~10            |
| 2        | 80.81       | 40.41       | 48%      | 8             | 2             | 75~80      | 5~10            |
| 3        | 99.65       | 33.22       | 49%      | 3             | 2             | 69~91      | 5~10            |
| 4        | 114.83      | 28.71       | 49%      | 3             | 2             | 80-85      | 10~20           |
| 6        | 154.78      | 25.80       | 50%      | 2             | 2             | 90~95      | 10~20           |
| 8        | 195.96      | 24.50       | 50%      | 4             | 3             | 75~95      | 10~20           |
| 12       | 278.13      | 23.18       | 51%      | 5             | 4             | 79~95      | 15~25           |
| 24       | 519.43      | 21.64       | 54%      | 23            | 15            | 90~95      | 10~40           |
| 48       | 1061.36     | 22.11       | 61%      | 3             | 2             | 90~95      | idle10-;busy90+ |
| 72       | 1574.88     | 21.87       | 67%      | 5             | 3             | 90~95      | idle10-;busy90+ |
| 96       | 2106.74     | 21.95       | 74%      | 5             | 3             | 90~95      | idle10-;busy90+ |
| 120      | 2706.47     | 22.55       | 84%      | 8             | 5             | 90~95      | idle10-;busy90+ |

- pointing为24以下，处理效率偏低；
- pointing为24以上，CPU利用率波动大（出现明显的忙时波峰、闲时波谷）；
- pointing越大，产生中间结果越大，需要越多的中间存储，灵活性、扩展性不好；
- 若pointing越小，则单task计算量越小，若单task计算量太小，会导致task数量更多，增加管理开销；

综合考虑，pointing取24为当前硬件条件下最佳选择。

## 二、24指向多DCU测试

| no. dcu | run-seconds | avg-seconds | speedup | DCU VRAM | idle interval | busy interval | busy power | CPU usage | cpu-usr | cpu-sys | cpu-idle |
|---------|-------------|-------------|---------|----------|---------------|---------------|------------|-----------|---------|---------|----------|
| 1       | 519.43      | 21.64       | 1.000   | 54%      | 23            | 15            | 90~94      | 10~40     | 15~22   | 4~5     | 73~81    |
| 2       | 526.29      | 21.93       | 1.974   | 54%      | 14            | 11            | 85~95      | 20~90     | 28~42   | 7~9     | 50~63    |
| 3       | 559.78      | 23.32       | 2.783   | 54%      | 12            | 13            | 70~105     | 20~90     | 40~55   | 10~12   | 33~48    |
| 4       | 568.87      | 23.70       | 3.652   | 54%      | 7             | 10            | 85~105     | 40~100    | 55~65   | 12~14   | 25~35    |

DCU从1到4，240秒数据单指向处理的加速比从1.000到3.652，接近线性。并且其CPU处理能力还有余量。

## 三、24指向多时长测试

| data seconds | run-seconds | avg-seconds | DCU VRAM | busy power | CPU usage | cpu-usr | cpu-sys | cpu-idle |
|--------------|-------------|-------------|----------|------------|-----------|---------|---------|----------|
| 30           | 80.01       | 2.667       | 54%      | 88~94      | 5~40      | 16~21   | 4~5     | 75~79    |
| 60           | 147.12      | 2.452       | 54%      | 84~94      | 5~50      | 16~22   | 4~5     | 73~79    |
| 90           | 201.67      | 2.241       | 54%      | 86~97      | 5~55      | 16~22   | 4~5     | 74~80    |
| 120          | 280.11      | 2.334       | 54%      | 84~92      | 5~50      | 15~22   | 4~5     | 73~81    |
| 150          | 343.51      | 2.290       | 54%      | 84~94      | 5~50      | 17~22   | 4~5     | 73~79    |
| 180          | 409.54      | 2.275       | 54%      | 84~93      | 5~55      | 16~21   | 4~5     | 74~81    |
| 210          | 430.38      | 2.049       | 54%      | 87~93      | 5~55      | 15~22   | 4~5     | 73~81    |
| 240          | 519.43      | 2.164       | 54%      | 88~94      | 10~40     | 15~22   | 4~5     | 73~81    |
| 270          | 621.83      | 2.303       | 54%      | 83~93      | 10~55     | 16~21   | 4~5     | 73~80    |
| 300          | 682.81      | 2.276       | 54%      | 79~94      | 10~55     | 16~23   | 4~6     | 70~84    |
| 330          | 753.19      | 2.282       | 54%      | 79~94      | 10~55     | 20~22   | 4~6     | 74~76    |
| 360          | 805.96      | 2.239       | 54%      | 79~94      | 10~55     | 14~18   | 4~5     | 77~82    |
| 390          | 987.42      | 2.532       | 54%      | 79~94      | 10~55     | 14~17   | 4~5     | 70~74    |

- 从测试的科学需求看，数据越长，效果越好
- 数据时长从30秒到390秒，单秒数据的处理时长变化不大。
- 若增加本地SSD容量，可容纳单个观测集单channel的空间容量（4800s * 313MB/s≈1.44TB），是否可单次完整4800秒数据处理？
