# MWA流水线相关数据统计

## 一、主要阶段数据及数据量统计

MWA流水线涉及的主要数据包括：
1. 定标数据
2. 原始产品数据（*.dat）
3. 单指向、单通道的？？数据（fits格式）
4. 单指向24通道？？数据（fits格式）
5. 最终搜索结果候选体数据：通过presto消色散、搜索得到的候选体文件

### 1.1 定标数据
- 按每个观测集来组织，还包含运行相关元数据等
- 数据规模相对固定，每个观测集的数据量：约72MiB

### 1.2 原始产品数据（DIR_DAT）
- 按时间戳（秒）打包的24通道数据（后缀名为tar），解包后文件后缀为.dat
- 按观测集的数据量统计
  - 单次观测的时间长度：4800秒
  - 通道数：24个，109~132
  - 每个文件字节数：327680000，313MiB
  - 文件总数：4800*24=115,200 个
  - 总数据量：3.775*10^13 Bytes = 3.6*10^7 MiB ≈ 34.33 TiB

### 1.3 单指向中间结果（DIR_1CH，单通道/fits格式）
- 合并时间序列的原始数据dat文件，通过make-beam生成单通道数据的fits文件
- 按观测集的单指向数据
  - 单指向、单通道30秒fits文件大小：38479680 B ≈ 36.70 MiB (1.223 MiB/秒)
  - 单指向单通道fits文件数量：24*4800/30=3840个
  - 总数据量：36.70 MiB * 3840 ≈ 137.61 GiB，约为原始数据的0.39%

### 1.4 单指向中间结果（DIR_24CH，24通道/fits格式）
- 将单指向、单通道的fits文件合并为24通道的fits文件，总数据量跟单通道数据规模比较接近。
- 按观测集的单指向数据
  - 总数据量：137.00 GiB
  
### 1.5 presto搜索结果（DIR_RES）

- 单指向120秒数据处理结果约80MB，折合4800秒，数据量为3.21GB

### 1.6 总结
MWA数据处理过程中，需按1万多个指向进行处理，其读取数据量达原始数据的万倍以上，达到数百PB规模，其I/O优化是数据处理流水线设计的关键。此外流水线处理涉及到时间Time、通道channel、指向Pointing、色散DM等多维度交叉，如何优化模块设计、运行参数、处理顺序，减少中间文件占用，是数据处理流水线优化的另一个重点。

表1 MWA数据处理总量统计表（总指向数为12960）

|  数据分类     |           | 单通道单秒  | 单指向读写量 | 全指向读写量 |
|-----------   |-----------| --------  |  --------  |----------  |
| 原始产品数据   | DIR_DAT   | 313 MiB   | 34.33 TiB  | 434.5PiB   |
| 单通道中间结果 | DIR_1CH   | 1.223 MiB | 137.61 GiB | 1.70 PiB   |
| 24通道中间结果 | DIR_24CH  |           | 137.00 GiB | 1.69 PiB   |
| 脉冲搜索结果   | DIR_RES   |           | 3.21 GiB   | 40.63 TiB  |


## 二、物理流水线的实际数据量

beam-maker：24指向/次，单数据集压缩后数据量为23.7TiB，全指向数据：18.1PiB。

表2 MWA物理流水线数据总量统计表

|  数据分类       | 环境变量   | 单指向     |   全指向    |
|---------------|-----------|-----------|------------|
| 原始产品数据    | DIR_TAR   |  34.33 Ti |            |
| 再打包后数据    | DIR_REPACK| 23.7 TiB  |            |
| 原始数据       | DIR_DAT   | 34.33 TiB  | 18.1 PiB  |
| 单通道中间结果  | DIR_1CH   | 137.61 GiB | 1.70 PiB  |
| 单通道重采样结果| DIR_1CHX  | 28.24 GiB  | 357.41 TiB |
| 24通道中间结果  | DIR_24CH  | 28.31 GiB | 358.29 TiB |
| 脉冲搜索结果    | DIR_RES  |  880 MiB   | 10.88 TiB  |


## 三、流水线运行相关的性能数据

按[beam-maker模块性能测试数据](../dockerfiles/mwa-vcstools/beam-maker/test/README.md)，在DCU节点上，处理24指向150秒数据，耗时343.51秒。折合为单指向4800秒数据，耗时10992.32秒。

- 计算资源：24节点，96个DCU
- 单指向计算时间：10992.32 s / 96 = 114.5 秒
- 全指向（12960个）计算时间：114.5秒 * 12960 = 1483920 秒 ≈ 17.175天 

- 以单轮处理1440指向，单次24指向，单轮处理60次。

### 原始数据网络读取

- 平均读取带宽：23.7 TiB / 1440 / 114.5 s = 150 MiB/s 

- 读取轮次：12960 / 1440 = 9次
- 读取数据量：23.7 TiB * 9 = 213.3 TiB

### 24通道中间结果读写

- 读写带宽：28.31GiB / 114.5 s = 253.2 MiB/s

- 24通道中间结果的空间占用：28.31GiB * 1440 = 39.81 TiB
